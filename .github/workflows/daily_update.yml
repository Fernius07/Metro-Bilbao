name: Daily GTFS Update

on:
  schedule:
    # Run at 03:30 UTC every day (04:30 CET / 05:30 CEST)
    # Metro Bilbao updates at 04:00 CET, so this ensures we catch the update
    - cron: '30 3 * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-gtfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Run Selective GTFS Update Script
      run: |
        echo "Starting selective GTFS update..."
        python update_gtfs.py
        echo "Update completed successfully"

    - name: Validate GTFS Data
      run: |
        echo "Validating GTFS data integrity..."
        python validate_gtfs.py
        echo "Validation completed"

    - name: Check for changes
      id: check_changes
      run: |
        # Check if files exist and have changes
        if [ -f gtfs/gtfs-data.json ]; then
          git diff --quiet gtfs/*.txt gtfs/gtfs-data.json || echo "has_changes=true" >> $GITHUB_OUTPUT
          if git diff --quiet gtfs/*.txt gtfs/gtfs-data.json; then
            echo "No changes detected in GTFS data"
          else
            echo "Changes detected in GTFS data"
            git diff --stat gtfs/
          fi
        else
          echo "First run - gtfs-data.json created"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and Push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add gtfs/*.txt gtfs/gtfs-data.json
        git commit -m "ðŸ”„ Auto-update GTFS schedules $(date +'%Y-%m-%d %H:%M UTC')" -m "Updated dynamic files: stop_times, trips, calendar" || echo "No changes to commit"
        git push

    - name: Summary
      if: always()
      run: |
        echo "### GTFS Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… GTFS data updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Dynamic files (schedules) updated" >> $GITHUB_STEP_SUMMARY
          echo "- Static files (stops, shapes) preserved" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes in GTFS data" >> $GITHUB_STEP_SUMMARY
        fi
